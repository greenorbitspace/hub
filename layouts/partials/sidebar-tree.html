{{/* 
  Custom sidebar for Green Orbit Docs
  - Dynamic top-level sections from params.mainSections
  - Fallback to .FirstSection if current page isn't in a main section
*/}}

{{ $sidebarCacheLimit := .Site.Params.ui.sidebar_cache_limit | default 2000 -}}
{{ $shouldDelayActive := ge (len .Site.Pages) $sidebarCacheLimit -}}

<div id="td-sidebar-menu" class="td-sidebar__inner{{ if $shouldDelayActive }} d-none{{ end }}">

  {{ if not .Site.Params.ui.sidebar_search_disable -}}
  <form class="td-sidebar__search d-flex align-items-center">
    {{ partial "search-input.html" . }}
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button"
      data-bs-toggle="collapse" data-bs-target="#td-section-nav"
      aria-controls="td-section-nav" aria-expanded="false"
      aria-label="Toggle section navigation">
    </button>
  </form>
  {{ end -}}

  <nav class="td-sidebar-nav collapse
      {{- if .Site.Params.ui.sidebar_search_disable }} td-sidebar-nav--search-disabled{{ end -}}
      {{- if .Site.Params.ui.sidebar_menu_foldable }} foldable-nav{{ end -}}"
      id="td-section-nav">

    {{ if (gt (len .Site.Home.Translations) 0) -}}
    <div class="td-sidebar-nav__section nav-item dropdown d-block d-lg-none">
      {{ partial "navbar-lang-selector.html" . }}
    </div>
    {{ end -}}

    {{/* Determine the current top-level section */}}
    {{ $mainSections := .Site.Params.mainSections | default (slice "handbook" "glossary" "ims" "tech" "marketing" "legal" "about") -}}
    {{ $currentSection := .Section }}
    {{ $navRoot := .Site.Sections | where "Section" "eq" $currentSection | first }}

    {{/* Fallback if page is not in a main section */}}
    {{ if not $navRoot }}
      {{ $navRoot = .FirstSection }}
    {{ end }}

    {{ $ulNr := 0 -}}
    {{ $ulShow := .Site.Params.ui.ul_show | default 1 -}}
    {{ $sidebarMenuTruncate := .Site.Params.ui.sidebar_menu_truncate | default 100 -}}

    <ul class="td-sidebar-nav__section pe-md-3 ul-{{ $ulNr }}">
      {{ template "section-tree-nav-section" (dict 
        "page" . 
        "section" $navRoot 
        "shouldDelayActive" $shouldDelayActive 
        "sidebarMenuTruncate" $sidebarMenuTruncate 
        "ulNr" $ulNr 
        "ulShow" (add $ulShow 1)) 
      }}
    </ul>
  </nav>
</div>

{{/* Recursive template for section tree */}}
{{ define "section-tree-nav-section" -}}
  {{ $s := .section -}}
  {{ $p := .page -}}
  {{ $shouldDelayActive := .shouldDelayActive -}}
  {{ $sidebarMenuTruncate := .sidebarMenuTruncate -}}
  {{ $ulNr := .ulNr -}}
  {{ $ulShow := .ulShow -}}
  {{ $active := and (not $shouldDelayActive) (eq $s $p) -}}
  {{ $activePath := and (not $shouldDelayActive) (or (eq $p $s) ($p.IsDescendant $s)) -}}
  {{ $show := or (lt $ulNr $ulShow) $activePath (not $p.Site.Params.ui.sidebar_menu_foldable) -}}
  {{ $mid := printf "m-%s" ($s.RelPermalink | anchorize) -}}

  {{ $pages_tmp := where (union $s.Pages $s.Sections).ByWeight ".Params.toc_hide" "!=" true -}}
  {{ $pages := $pages_tmp | first $sidebarMenuTruncate -}}
  {{ $truncatedEntryCount := sub (len $pages_tmp) $sidebarMenuTruncate -}}
  {{ if gt $truncatedEntryCount 0 -}}
    {{ warnf "WARNING: %d sidebar entries truncated. Increase params.ui.sidebar_menu_truncate to %d for section: %s"
        $truncatedEntryCount (len $pages_tmp) $s.Path -}}
  {{ end -}}
  {{ $withChild := gt (len $pages) 0 -}}

  {{ $manualLink := cond (isset $s.Params "manuallink") $s.Params.manualLink (cond (isset $s.Params "manuallinkrelref") (relref $s $s.Params.manualLinkRelref) $s.RelPermalink) -}}
  {{ $manualLinkTitle := cond (isset $s.Params "manuallinktitle") $s.Params.manualLinkTitle $s.Title -}}

  <li class="td-sidebar-nav__section-title td-sidebar-nav__section{{ if $withChild }} with-child{{ else }} without-child{{ end }}{{ if $activePath }} active-path{{ end }}"
      id="{{ $mid }}-li">
    <a href="{{ $manualLink }}"
      class="align-left ps-0{{ if $active }} active{{ end }} td-sidebar-link{{ if $s.IsPage }} td-sidebar-link__page{{ else }} td-sidebar-link__section{{ end }}"
      id="{{ $mid }}">
      {{ with $s.Params.Icon }}<i class="{{ . }}"></i>{{ end }}
      <span class="{{ if $active }}td-sidebar-nav-active-item{{ end }}">{{ $s.LinkTitle }}</span>
    </a>

    {{ if $withChild }}
    {{ $ulNr := add $ulNr 1 }}
    <ul class="ul-{{ $ulNr }}{{ if (gt $ulNr 1) }} foldable{{ end }}">
      {{ range $pages -}}
        {{ if (not (and (eq $s $p.Site.Home) (eq .Params.toc_root true))) -}}
          {{ template "section-tree-nav-section" (dict 
            "page" $p 
            "section" . 
            "shouldDelayActive" $shouldDelayActive 
            "sidebarMenuTruncate" $sidebarMenuTruncate 
            "ulNr" $ulNr 
            "ulShow" $ulShow) }}
        {{ end -}}
      {{ end -}}
    </ul>
    {{ end -}}
  </li>
{{- end -}}